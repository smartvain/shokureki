import type { RawActivity } from "@/services/collectors/github";

export function buildDailySummaryPrompt(activities: RawActivity[], manualNotes?: string) {
  const activityList = activities
    .map((a) => {
      let line = `- [${a.activityType}] ${a.title}`;
      if (a.body) {
        line += `\n  詳細: ${a.body.slice(0, 1000)}`;
      }
      if (a.metadata.repo) {
        line += `\n  リポジトリ: ${a.metadata.repo}`;
      }
      return line;
    })
    .join("\n\n");

  const manualSection = manualNotes ? `\n\n## 手動メモ\n${manualNotes}` : "";

  return `あなたはシニアエンジニアの職務経歴書作成を専門とするキャリアコンサルタントです。
エンジニアの1日の活動データ（PRタイトル・本文、レビュー、Issue等）を深く分析し、職務経歴書に即座に記載できるレベルの詳細な実績候補を抽出してください。

## 重要ルール

### 匿名化
- 会社固有のプロジェクト名、コードネーム、社内用語は一般的な表現に置き換える
  - 例: "Project Phoenix" → "社内基幹システム刷新プロジェクト"
  - 例: "JIRA-1234" → 削除
  - 例: "hogehoge-service" → "マイクロサービス"

### リポジトリの役割表記
- リポジトリ名はそのまま使わず、そのリポジトリの役割を一般化した名前に置き換える
  - 例: "acme/frontend-web" → "求人マッチングWebフロントエンド"
  - 例: "acme/api-rails" → "求人マッチングAPIサーバー"
  - リポジトリ名や活動内容から、そのリポジトリが担うサービス上の役割を推測する

### 記述の詳細さ（最重要）
- **曖昧で抽象的な記述は絶対に避ける**。以下のような表現はNG:
  - ❌ 「コードの可読性と保守性を高めました」
  - ❌ 「UIの改善を行いました」
  - ❌ 「リファクタリングを実施しました」
  - ❌ 「パフォーマンスを向上させました」
- **PRタイトルと本文から具体的な技術的内容を読み取り、以下を必ず含める**:
  1. **課題・背景**: なぜその作業が必要だったのか（推測でもよい）
  2. **具体的な対応内容**: どの技術要素に対して、どのようなアプローチで対応したか
  3. **技術的な詳細**: 使用した設計パターン、アーキテクチャ上の判断、具体的な実装手法
  4. **成果・効果**: その変更がもたらす具体的な効果
- PRの本文（description）に書かれている技術的な詳細を最大限活用すること

### 記述例（目指すべき品質）
以下は良い記述の例です:

例1: 「フォームバリデーションのリファクタリング」というPRの場合
- ❌ 悪い例: 「フォームのバリデーション処理をリファクタリングし、保守性を向上させました。」
- ✅ 良い例: 「求人マッチングWebフロントエンドにおいて、フォームバリデーション処理をReact Hook Form + Zodによるスキーマベースのバリデーションに移行。従来の手続き的なバリデーション処理を宣言的に書き換え、バリデーションルールの一元管理を実現した。」

例2: 「API レスポンスのキャッシュ実装」というPRの場合
- ❌ 悪い例: 「APIのパフォーマンスを改善しました。」
- ✅ 良い例: 「APIサーバーにおいて、頻繁にアクセスされるマスタデータ系エンドポイントにRedisを用いたキャッシュレイヤーを導入。キャッシュの無効化戦略としてWrite-Through方式を採用し、データ整合性を保ちながらレスポンスタイムを改善した。」

例3: レビュー活動の場合
- ❌ 悪い例: 「チームメンバーのPRをレビューしました。」
- ✅ 良い例: 「非同期処理を含む決済フローの実装PRに対してコードレビューを実施。エラーハンドリングの不足やリトライ戦略の改善点を指摘し、冪等性を担保する設計への修正を提案した。」

### その他のルール
- **技術キーワード**: プログラミング言語、フレームワーク、ライブラリ名は具体的に残す
- **除外**: typo修正、README更新等の些末な活動は除外
- **統合**: 同一リポジトリ内の密接に関連する活動は1つの実績にまとめる（ただし、異なる技術領域の作業は分けて記載）
- **言語**: 日本語で出力

## 活動データ
${activityList}${manualSection}

## 出力形式
以下のJSON形式で出力してください:
{
  "dailySummary": "今日の活動の技術的な概要。具体的に何に取り組んだか、どのような技術的判断をしたかを含めて3-5行で記述",
  "repoSummaries": [
    {
      "repoRole": "リポジトリの役割を一般化した名前（例: 求人マッチングWebフロントエンド）",
      "summary": "そのリポジトリでの活動の技術的な概要（2-3文。具体的な技術要素を含める）"
    }
  ],
  "achievementCandidates": [
    {
      "title": "実績の短いタイトル（20文字以内）",
      "description": "職務経歴書にそのまま記載できる詳細な実績文。課題・背景→具体的な対応内容（技術的詳細を含む）→成果・効果の構造で、3-5文で記述する。PRの本文に含まれる技術的な情報を最大限活用すること。",
      "repoRole": "この実績に関連するリポジトリの役割名（repoSummariesのrepoRoleと一致させる）",
      "category": "development | review | bugfix | design | documentation | communication | leadership",
      "technologies": ["React", "TypeScript"],
      "significance": "high | medium | low"
    }
  ]
}

活動がない場合や実績にならない些末な内容のみの場合は、achievementCandidatesを空配列、repoSummariesも空配列にしてください。`;
}
